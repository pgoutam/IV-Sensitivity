---
title: "IV Sensitivity - UCI Approach"
author: "Prodyumna Goutam"
date: "1/29/2019"
output: html_document
---

This notebook is based on the paper "Plausibly Exogenous"(Conley et al, ReStat 2012) and the excellent Stata package **plausexog** written by Damian Clarke and Benjamin Matta.  The ReStat paper can be found [here](https://www.mitpressjournals.org/doi/10.1162/REST_a_00139) and the companion paper to the stata package can be found [here](https://www.stata-journal.com/article.html?article=st0538)

The basic approach can be stated as follows: IV analysis relies on the assumption that the instrument affects the outcome only through endogenous variable. Conley et al. (2012) show approaches to conducting inference with relaxations of this requirement. In addition to its effect through the endogenous variable, they allow the instrument to directly affect the outcome variable. 


```{r, message = FALSE}
library(AER)
library(foreign)
library(Formula)
library(formula.tools)
```


```{r}
uci <- function(form,instr,gmin,gmax,grid = 2,data) {
  # Check presence of model inputs 
  if (missing(form)) stop("Missing formula")
  if (missing(instr)) stop("Missing instruments")
  if (missing(gmin)) stop("Missing min support")
  if (missing(gmax)) stop("Missing max support")
  if (missing(data)) stop("Data not provided")
  
  # Check if size of support vectors match up 
  if (length(gmin) != length(gmax)) stop("Min and max lengths different")
  
  # Create support grid 
  gam_list <- list() 
  for (i in 1:length(gmin)){
    gam_list[[i]] <-seq(from = gmin[1], to = gmax[i], length.out = grid)
  }
  gamdf <- expand.grid(gam_list) #All combos of gamma values
  
  #Create list of modified IV formulae
  ivlist <- create_ivformula(form,instr,gamdf)
  
  # Iterate to get bounds 
  uci_bds <- uci_iterate(ivlist,data)
}
```

```{r}
create_ivformula <- function(form,instr,gamdf) {
  # Extract relevant formula components 
  iv <- formula.tools::rhs.vars(instr)
  endo <- formula.tools::lhs.vars(instr)
  dep <- formula.tools::lhs.vars(form)
  exo <- formula.tools::rhs.vars(form)
  
  # Underidentified model? 
  if(length(iv) < length(endo)) stop("Num iv less than num endo vars")
  
  # Construct RHS side of the formula 
  rhs1 <- paste(paste(exo, collapse = "+"),paste(endo, collapse = "+"),sep = "+") 
  rhs2 <- paste(exo <- paste(exo, collapse = "+"),paste(iv, collapse = "+"),sep = "+")
  
  # Create list of ivformula 
  ivlist <- list()
  for (i in 1:nrow(gamdf)) {
    gam <- unlist(gamdf[i,])
    dep_mod <- paste(gam,iv,sep = "*",collapse = "-")
    lhs <- paste0("I(",dep,"-",dep_mod,")")
    ivlist[[i]] <- as.Formula(paste(lhs,
                           paste(rhs1,rhs2, sep = "|"),
                           sep = "~"))
  }
  return(ivlist)
}
```

```{r}
uci_iterate <- function(ivlist,data) {
    iv_res <- lapply(ivlist,ivreg,data = data)
    ci <- lapply(iv_res,confint)
    # Construct lower and upped bound
    ci_l <- ci[[1]][,1]
    ci_h <- ci[[1]][,2]
    for (i in 2:length(ci)) {
      ci_l <- pmin(ci_l,ci[[i]][,1])
      ci_h <- pmax(ci_h,ci[[i]][,2])
    }
    uci_bounds <- cbind("lb" = ci_l,"ub" = ci_h)
    return(uci_bounds)
}
```



